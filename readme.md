# Nix (darwin) on macOS

## Installation

### Installing through script (recommended)

`curl -fsSL https://raw.githubusercontent.com/kerdamon/nixOS-configuration/main/installers/init_darwin.sh | sh`

### Manual install steps

- Install xcode
  - `xcode-select --install`
- Install nix
  - Recommended [determinate nix (fork)](https://github.com/DeterminateSystems/nix-installer): `curl -fsSL https://install.determinate.systems/nix | sh -s -- install`
    - flakes by default
    - easy uninstallation (one command)
    - nix survives macOS upgrades
  - Alternatively - official installer: `sh <(curl --proto '=https' --tlsv1.2 -L https://nixos.org/nix/install)`
  - Note: Installs can be "upgraded". This means after installing using official installer you can just use determinate script to start managing it by determinate installer.

## Rebuild and update

To rebuild system use `nix-switch` (alias). To update flake and then switch use `nix-update-switch` (script).

## Things configured by hand

- copy ssh keys (e.g for [github](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account)) to path specified in [dotfiles/ssh.conf](dotfiles/ssh.conf)
- karabiner-elements should work (if problem with grabber is still present go to settings Privacy and protection > input monitoring and add `/Library/Application\ Support/org.pqrs/Karabiner-Elements/bin/karabiner_grabber` manually)

# Home-manager standalone on linux

## Installation

### Installing through script (recommended)

- Install fresh linux distro and run `wget https://raw.githubusercontent.com/kerdamon/nixOS-configuration/main/installers/init_generic_linux.sh && chmod +x init_generic_linux.sh && ./init_generic_linux.sh`

### Manual install steps

- Install nix `sh <(curl -L https://nixos.org/nix/install) --daemon`
- Enable experimental features
  - Add `experimental-features = nix-command flakes` to `/etc/nix/nix.conf`
- Init home-manager `nix run home-manager/master -- init --switch`

## Switching to new config after making changes to configuration

- Flakes: `home-manager switch --flake <path>#<output-name>`
- Without flake: `home-manager switch`

## Rebuild and update

To rebuild system use `nix-switch` (alias). To update flake and then switch use `nix-update-switch` (script).

## Things configured by hand
This is list of configuration and installed packages done outside of home-manager (mostly because it cannot be done through hm or is not working)

### Packages

- `keyd` - sudo needed
  - `make` - needed for keyd
  - `gcc` - needed for keyd
  - `sudo apt install make`, `suto apt install gcc`
  - `git clone https://github.com/rvaiya/keyd`
  - `cd keyd`
  - `make && sudo make install`
  - `sudo systemctl enable keyd && sudo systemctl start keyd`

- `tailscale` - sudo needed
  - installed through official install command `curl -fsSL https://tailscale.com/install.sh | sh`

### Fixes
Fixes and tweaks.

- `zsh`
  - installed and configured through hm, but setting as login shell need sudo
  - path from nix profile (`which zsh`) was added to `/etc/shells` (valid login shells)
  - chsh was invoked, setting the zsh as login shell

- Lifting AppArmor restrictions
  - in Ubuntu 24.04 by default AppArmor restricts non-root users to use sandboxing in application, so many of apps installed with hm does not work
  - Apps are returning errors: `The SUID sandbox helper binary was found, but is not configured correctly. Rather than run without sandboxing I'm aborting now. You need to make sure that /nix/store/b839r5g9ywf4fkama8zah8r55nwbzmky-electron-31.4.0/libexec/electron/chrome-sandbox is owned by root and has mode 4755.`
  - fix - lift restriction for non-root users 
    - for one session: `sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0`
    - persisting through sessions:
      - add `kernel.apparmor_restrict_unprivileged_userns=0` to `/etc/sysctl.d/<example-filename>.conf`
      - `sudo sysctl -p` or reboot to apply changes 
    - based on [this](https://github.com/electron/electron/issues/42510#issuecomment-2171583086) and [this](https://github.com/arduino/arduino-ide/issues/2429#issuecomment-2099775010)

# NixOS on raspberry pi

## Instalation

There is installer in `installers/sd-raspberrypi.nix`. It requires to be built on arch, so easiest way is to build on already running NixOS on raspberrypi. It is self-contained, but needs two other files with secrets in the same folder:

1. `wifi.conf` - defines wifi ssid and passkey 
2. `ssh.key.pub` - public key for ssh connection

### Prerequisites

`wifi.conf` - content of file should be nix attribute set with two fields - `ssid` and `psk`. Both should be string.

Example:
```
{
  ssid = "nazwasieci";
  psk = "haslo";
}
```

`ssh.key.pub` - this file should be public key generated by ssh-keygen.

Example:
```
ssh-ed25519 SOME_SECRET_STRING kered@keospc
```

### Build command

`nix-build '<nixpkgs/nixos>' -A config.system.build.sdImage -I nixos-config=./sd-raspberrypi.nix`

This will build image of system and create symlink to it in directory where invoked. In this directory there is image that could be flashed to sd card using etcher, rufus or dd.

### Next steps

1. Setup password using `passwd`
2. Clone this repo
3. `nixos-rebuild switch` to new configuration

# Sources

- Determinate nix
  - [website](https://docs.determinate.systems)
  - [Installer](https://github.com/DeterminateSystems/nix-installer)
- [Nix Darwin](https://github.com/nix-darwin/nix-darwin)
- Home manager
  - [Docs](https://nix-community.github.io/home-manager/)
  - [Github](https://github.com/nix-community/home-manager)
- Learning and resources
  - [Zero to nix](https://zero-to-nix.com)
  - [Package search](https://search.nixos.org/packages)
  - [MyNixOs - options documentation](https://mynixos.com)
